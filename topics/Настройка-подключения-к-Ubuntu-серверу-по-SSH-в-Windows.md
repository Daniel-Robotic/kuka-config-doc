# Настройка подключения к Ubuntu серверу по SSH в Windows

Подключение по ssh к Ubuntu серверу в Windows возможно двумя способами:
- Использование встроенной командной строки
- Использование сторонних приложений (например Putty)

> Подключение с использованием встроенной командной строки Windows
> возможно только с версии Windows 10 и выше
> {style="warning"}

> Использование Putty позволяет отображать графические приложения прямо из консоли
> {style="note"}

## Подключение с использованием командной строки Windows

Для подключения к серверу Ubuntu необходимо ввести следующую команду:
```Bash
ssh user@ip -p 22
```
где `user` имя пользователя сервера, `ip` адрес хоста, `-p 22` порт на котором находиться хост.
> По умолчанию используется **22** порт, по этому ключ со значением `-p 22` можно не использовать
> если Ваш порт не менялся.
> {style="note"}

При первом подключении система спросит у Вас, производить сохранение ключа доступа.
Отвечаем `yes`.

```
The authenticity of host '192.168.21.1 (192.168.21.1)' can't be established.
ECDSA key fingerprint is SHA256:aD+XaI1+N7WhZU82Qlqznd3onFU2VqiNgLrJLe6ikSY.
Are you sure you want to continue connecting (yes/no/[fingerprint])?
```

После система потребуют пароль пользователя, который необходимо ввести.

> В SSH существует несколько способов авторизации.
Вы можете каждый раз вводить пароль пользователя или использовать более безопасный и надежный способ - ключи SSH.
Что самое интересное, он более удобен для применения, вам даже не нужно будет вводить пароль.

Сначала необходимо создать ключи ssh для аутентификации на локальном сервере.
Для этого существует специальная утилита ssh-keygen, которая входит в набор утилит OpenSSH.
По умолчанию она создает пару 2048 битных RSA ключей, которая подойдет не только для SSH, но и для большинства других ситуаций.

Итак, генерация ключей ssh выполняется командой (в Windows):
```Bash
ssh-keygen
```
Утилита предложит вам выбрать расположение ключей.
По умолчанию ключи располагаются в папке _С:/users/user/.ssh/_
Лучше ничего не менять, чтобы все работало по умолчанию и ключи автоматически подхватывались.
Секретный ключ будет называться **id_rsa**, а публичный **id_rsa.pub**.

Затем утилита предложит ввести пароль для дополнительного шифрования ключа на диске.
Его можно не указывать, если не хотите.
Использование дополнительного шифрования имеет только один минус - необходимость вводить пароль, и несколько преимуществ:
- Пароль никогда не попадет в сеть, он используется только на локальной машине для расшифровки ключа. Это значит что перебор по паролю больше невозможен.
- Секретный ключ хранится в закрытом каталоге и у клиента ssh нет к нему доступа пока вы не введете пароль.
- Если злоумышленник хочет взломать аутентификацию по ключу SSH, ему понадобится доступ к вашей системе. И даже тогда ключевая фраза может стать серьезной помехой на его пути.

Но все же, это необязательное дополнение и если не хотите, то вы можете просто нажать Enter. Тогда доступ по ключу ssh будет выполняться автоматически и вам не нужно будет что-либо вводить.

Теперь у вас есть открытый и закрытый ключи SSH и вы можете использовать их для проверки подлинности.
Дальше нам осталось разместить открытый ключ на удаленном сервере.

Когда генерация ключей завершена, нам осталось только загрузить ключ на сервер.
Для загрузки ключа можно использовать несколько способов.
В некоторых случаях вы можете указать ключ в панели управления сервером, например, сPanel или любой другой.
Но мы такой способ рассматривать не будем.
Мы рассмотрим ручные способы.

Самый простой способ скопировать ключ на удаленный сервер - это использовать утилиту ssh-copy-id.
Она тоже входит в пакет программ OpenSSH.
Но для работы этого метода вам нужно иметь пароль доступа к серверу по SSH.
Синтаксис команды:

```Bash
ssh-copy-id user@ip
```

При первом подключении к серверу система может его не распознать, поэтому вам нужно ввести `yes`.
Затем введите ваш пароль пользователя на удаленном сервере.
Утилита подключится к удаленному серверу, а затем использует содержимое ключа **id.rsa.pub** для загрузки его на сервер в файл _~/.ssh/authorized_keys_.
Дальше вы можете выполнять аутентификацию с помощью этого ключа.

Если описанный выше способ не работает, переходим в папку _C:\Users\user\.ssh_ открываем файл **id.rsa.pub** и копируем все содержимое.
Для выполнения в терминале всех действий воспользуемся следующими командами:
```Bash
cd C:\Users\user\.ssh
more .\id_rsa.pub

# Output
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAL...
```

Копируем ключ.
Далее переходим на наш удаленный сервер, где создаем папку `.ssh` и файл `authorized_keys`, для этого выполним команды (Ubuntu):
```Bash
mkdir ~/.ssh/
cd ~/.ssh/
touch authorized_keys

echo ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAL... >> authorized_keys
```

Для проверки, что наш ключ вставился в файл, проведем проверку командой:
```Bash
cat authorized_keys

# Output
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAL...
```

Мы должны увидеть выведенный наш ключ.
Если ключ выводиться, закрываем соединение и подключаемся заново.
Пароль больше не требуется.


## Подключение с использованием Putty

Основным недостатком использования встроенной командной строки Windows может служить невозможность запуска GUI приложений.
Для решения данной проблемы имеется возможность использования сторонних программных продуктов, т.к. [putty](https://www.putty.org/).
Также нам понадобиться [X11 сервер](https://sourceforge.net/projects/vcxsrv/), который позволит запускать графические приложения используя ssh подключение.

### Конфигурирование

После установки putty, в папке установки или в Пуск меню, найдите приложение **puttygen.exe** и запустите его.
- **Тип ключа для генерации** выберите SSH-2 RSA. Длина генерируемого ключа(в битах): введите **4096**.
- Нажмите кнопку **Генерировать**.
- Хаотично перемещайте курсор мыши внутри окна программы.
- Введите желаемый комментарий к созданным ключам, чтобы Вам было удобнее различать созданные ключевые пары в будущем.
-  Если Вы желаете (не обязательно), введите пароль для закрытого ключа.
- Сохраните открытый и личный (закрытый) ключ, не перепутайте ключи в будущем.
- Не закрываем окно программы генерации ключей PuTTY.
- Подключаемся по ssh к нашему Ubuntu серверу и вводим следующие команды:

```Bash
cd ~/.ssh/
echo ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAL... >> authorized_keys
```

> Здесь используется ваш сгенерированный ключ в **puttygen.exe**
{style="warning"}

В приложении **putty.exe**, вводим данные системы:

![putty_main.png](putty_main.png)

Далее переходим в **Connection -> SSH -> Auth -> Credentials** и в поле **Private key file for authentication:** выбираем файл с нашим приватным ключом

![putty_shh_credentials.png](putty_shh_credentinals.png)

Далее подключаемся к серверу. При первом подключении putty спросит о сохранении данных о сервере, нажимаем кнопку **Accept**.

### Вывод GUI приложений

Для вывода GUI приложений, производим установку [X11 сервера](https://sourceforge.net/projects/vcxsrv/).
После чего производим запуск **X11 Launcher**

![X11_main.png](X11_main.png)

В основном окне оставляем параметры по умолчанию.

![x11_select_client.png](x11_select_client.png)

Здесь также оставляем параметры по умолчанию.

В следующем окне убираем галочку с **Primary Selection**

![x11_primary.png](x11_primary.png)

В последнем окне нажимаем клавишу **готово**, наш **X11 сервер**, свернется в трей.

В Putty переходим по пути **Connection -> SSH -> X11**, в нем ставим активный чек-бокс **Enable X11 forwarding**
и подключаемся к нашему Ubuntu серверу.
Производим установку `ssh` и перезагружаем сервис `sshd`:

```Bash
sudo apt install ssh
service sshd restart
```

Для проверки работы **X11 сервера** введем команду `gedit`, должно появиться блокнот:

![gedit.png](gedit.png)