# Настройка Jetson

## Подготовительный этап

### Перевод устройства в режим принудительного восстановления

Для установки необходимой версии Ubuntu на Jetson, необходимо перевести устройство в режим принудительного восстановления.
Для этого необходимо замкнуть два контакта FORCE RECOVERY/RECOVERY и GND, как показано на рисунке ниже.

![Jetson в режим восстановления](Jetson_to_restore.png)

Для получения более подробной информации обратитесь к документации по оборудованию.
Обратите внимание, что этот шаг можно выполнить перед запуском SDK Manager, и это позволит автоматически определить целевое устройство.
Кроме того, мы можем вручную выбрать целевое устройство, и нам будет предложено выполнить этот шаг в необходимый момент процесса установки.

В нашем случае используются платы Jetson NX, в которые дополнительным модулем помещено NVMe хранилище.
Установку системы будем производить на внутреннее хранилище с дальнейшим переключением на NVMe хранилище.

## Установка Ubuntu на Jetson

### Установка SDK Manager с использованием Docker

Для установки [SDK Manager](https://developer.nvidia.com/sdk-manager) потребуется Docker, который был установлен в шаге [Установка пакетов на Ubuntu](Настройка-Ubuntu-сервера.md).

Перейдем на официальный сайт [SDK Manager](https://developer.nvidia.com/sdk-manager) и выберем интересующий вариант установки.

![SDK_Manager_download.png](SDK_Manager_download.png)

В нашем случае выбран Docker Image Ubuntu 20.04.
После скачивания файла переместим его в корневой каталог нашего Ubuntu сервера.
Перенос `sdkmanager-<version>-<build>.tar.gz` можно реализовать разными способами:

- Скачать файл сразу с Ubuntu сервера
- Перенос с помощью флешки
- Удаленно с помощью `scp`, `sftp`, `ftp` и т.д.

В данном руководстве показан процесс переноса с использованием `scp`.

Для этого необходимо, чтобы на стороне сервера был настроен `ssh`, как продемонстрировано в шаге [Установка пакетов на Ubuntu](Настройка-Ubuntu-сервера.md)

В терминале Windows или Linux необходимо ввести:

```Bash
scp -P 22 C:\Users\<user>\<folder>\sdkmanager-<version>-<build>.tar.gz user@192.168.21.1:/home/<user>
```
где
- `-P 22` - обозначает порт удаленного сервера, если вы его не меняли, данную опцию можно убрать
- `C:\Users\<user>\<folder>\sdkmanager-<version>-<build>.tar.gz` - полный путь до файла
- `user@192.168.21.1` - логин удаленного хоста, а также IP-адрес хоста,
- `:/home/<user>` - путь, куда необходимо скопировать файл.

После этого произведите подключение к удаленному хосту с использованием `ssh`.

```Bash
ssh user@192.168.21.1 -p 22
```

### Запуск SDK Manager

Из терминала произведем загрузку образа Docker:

```Bash
docker load -i ./sdkmanager-[version].[build#]-[base_OS]_docker.tar.gz
```

Рекомендуется пометить версию как "latest" для удобства использования:

```Bash
docker tag sdkmanager:[version].[build] sdkmanager:latest
```

По умолчанию исходный контейнер имеет чистый профиль и локальную базу данных.
Это необходимо учитывать при использовании образа и когда сохранять изменения (фиксировать) в новом образе.
Это будет зависеть от планов использования контейнера, есть ли план его повторного использования после установки или запуска каждый раз с чистого этапа.
Изменяйте свои планы в зависимости от того, планируете ли вы использовать отдельный контейнер для каждого выпуска SDK или уникальный.

Для прошивки требуется привилегированный доступ и подключение USB-портов к контейнеру:

```Bash
--privileged -v /dev/bus/usb:/dev/bus/usb/ -v /dev:/dev -v /media/$USER:/media/nvidia:slave
```

В зависимости от настроек безопасности локальной сети, вам может потребоваться настроить доступ к локальной сети с помощью `--network host`.
Это в первую очередь нужно, если вы хотите взаимодействовать с устройствами Jetson через режим L4T USB Device.

Локальным пользователем внутри Docker является nvidia с nvidia в качестве пароля. Домашняя папка — `/home/nvidia`.


ДДля дальнейшей работы необходимо произвести запуск SDK Manager в режиме CLI, для этого выполним следующую команду:

```Bash
docker run -it --privileged -v /dev/bus/usb:/dev/bus/usb/ -v /dev:/dev -v /media/$USER:/media/nvidia:slave --name JetPack_NX_Devkit --network host sdkmanager --cli
```

### Установка Ubuntu

В появившемся окне выбираем тип авторизации **NVIDIA Developer**

![image.png](Auth_CLI.png)

Сгенерируется QR-код, а также появится ссылка.
Выбираем любой понравившийся тип авторизации и авторизуемся на официальном сайте NVIDIA.


![QR_AUTH](QR_AUTH.png)

После авторизации система предложит выбрать, каким образом мы хотим продолжить работу:

- Install — Режим установки
- Download Only — Скачивание всех необходимых компонентов
- Uninstall — Удаление системы

Выбираем режим **Install**. После чего выбираем режим **Jetson**. 

Далее выбираем, на какой системе будет произведена системная конфигурация, по умолчанию выбрана **Host Machine** и **Target Hardware**.

Если вы хотите убрать пункт **Target Hardware**, перемещаем курсор и нажимаем клавишу **space**, для выбора нужного пункта.

В случае если **Target Hardware**, не был убран, будет предложено выбрать вашу версию Jetson:

![choose_jetson_ver.png](choose_jetson_ver.png)

Следующим действием выбираем нужную версию JetPack, в нашем случае это **JetPack 5.1.4**.

Далее выбираем необходимые модули для установки, выбор осуществляется при помощи клавиши **space**.

![deep_stream.png](deep_stream.png)

Если вам необходимо самостоятельно настроить устанавливаемые пакеты, в вопросе:
"**Do you want to customize the install settings?**" прописываем **y**.

![choose_packages.png](choose_packages.png)

Соглашаемся с загрузкой системы на Jetson.

![flash_jetson.png](flash_jetson.png)

Пакет установки оставляем по умолчанию. **Target HW image folder** также оставляем по умолчанию.

Далее будет предложено ознакомиться со всеми лицензиями, чтобы согласиться со всем сразу, выбираем второй пункт меню.

Далее производится скачивание необходимых пакетов в систему с последующей установкой системы на Jetson.

![image.png](Download_and_Install_packages.png)

Когда все пакеты будут установлены, появится дополнительное окно, в котором выбираем пункт загрузки системы на Jetson.

![continue_flash.png](continue_flash.png)

Далее будут выведены все подключенные устройства, выбираем нужное.

![devices.png](devices.png)

**OEM Configuration** выбираем **Pre-Config**

В поле **New Username**: прописываем новое имя пользователя
В поле **New Password**: прописываем пароль

![user_pass.png](user_pass.png)

Далее будет предложено выбрать устройство, на которое будет производиться установка системы.
В нашем случае выбирается **EMMC/SD Card**

![storage.png](storage.png)

После выбора устройства хранения будет производиться запись системы на ваш Jetson.

После полной установки появится дополнительное диалоговое окно, в котором выбираем пункт **Skip** и выходим с SDK Manager CLI.

![end_install.png](end_install.png)

Если у вас имеется несколько Jetson, которые необходимо настроить, сохраним сконфигурированный Docker образ:

```Bash
docker commit JetPack_NX_Devkit jetpack_nx_devkit:download
docker container rm  JetPack_NX_Devkit
```

Последующие запуски, без необходимости заново производить скачивание всех пакетов, выполняются при помощи команды:

```Bash
docker run -it --rm --privileged -v /dev/bus/usb:/dev/bus/usb/ jetpack_nx_devkit:download
```

### Известные проблемы

При установке JetPack SDK с помощью образа Docker SDK Manager сначала необходимо установить `qemu-user-static` и `binfmt-support` на хост-машине, а затем выполнить следующую команду на хост-машине:
```Bash
sudo update-binfmts --enable
```

Без выполнения этих действий вы получите следующую ошибку во время установки из компонента Файловая система и ОС:

```Bash
'dpkg': Exec format error
```

При установке SDK DRIVE с помощью образа Docker диспетчера SDK перепрошивка целевого объекта может завершиться ошибкой, если ADB запущен на хост-компьютере. Обязательно остановите ADB перед миганием, используя следующую команду на вашем хост-компьютере:

```Bash
sudo killall adb
```

## Конфигурация NVME накопителя на Jetson

...